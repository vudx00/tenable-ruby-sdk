# frozen_string_literal: true

require 'spec_helper'

RSpec.describe 'Vulnerability API Contract' do
  let(:base_url) { 'https://cloud.tenable.com' }
  let(:vulnerabilities_url) { "#{base_url}/workbenches/vulnerabilities" }

  let(:valid_api_keys_header) { 'accessKey=test-access-key;secretKey=test-secret-key;' }

  let(:vulnerability_response_body) do
    {
      'vulnerabilities' => [
        {
          'count' => 3,
          'plugin_family' => 'General',
          'plugin_id' => 12_345,
          'plugin_name' => 'Test Vulnerability',
          'severity' => 2,
          'vulnerability_state' => 'open'
        },
        {
          'count' => 1,
          'plugin_family' => 'Web Servers',
          'plugin_id' => 67_890,
          'plugin_name' => 'Another Vulnerability',
          'severity' => 4,
          'vulnerability_state' => 'open'
        }
      ]
    }
  end

  let(:unauthorized_response_body) do
    {
      'statusCode' => 401,
      'error' => 'Unauthorized',
      'message' => 'You need to log in to perform this request.'
    }
  end

  describe 'GET /workbenches/vulnerabilities' do
    context 'with valid authentication' do
      before do
        stub_request(:get, vulnerabilities_url)
          .with(headers: { 'X-ApiKeys' => valid_api_keys_header })
          .to_return(
            status: 200,
            headers: { 'Content-Type' => 'application/json' },
            body: vulnerability_response_body.to_json
          )
      end

      it 'returns 200 with a vulnerabilities array' do
        conn = Faraday.new(url: base_url) do |f|
          f.request :json
          f.response :json
          f.adapter Faraday.default_adapter
        end

        response = conn.get('/workbenches/vulnerabilities') do |req|
          req.headers['X-ApiKeys'] = valid_api_keys_header
        end

        expect(response.status).to eq(200)
        expect(response.body).to have_key('vulnerabilities')
        expect(response.body['vulnerabilities']).to be_an(Array)
      end

      it 'returns vulnerabilities with the expected fields' do
        conn = Faraday.new(url: base_url) do |f|
          f.request :json
          f.response :json
          f.adapter Faraday.default_adapter
        end

        response = conn.get('/workbenches/vulnerabilities') do |req|
          req.headers['X-ApiKeys'] = valid_api_keys_header
        end

        vulnerability = response.body['vulnerabilities'].first
        expect(vulnerability).to have_key('count')
        expect(vulnerability).to have_key('plugin_family')
        expect(vulnerability).to have_key('plugin_id')
        expect(vulnerability).to have_key('plugin_name')
        expect(vulnerability).to have_key('severity')
        expect(vulnerability).to have_key('vulnerability_state')
      end

      it 'returns numeric values for count, plugin_id, and severity' do
        conn = Faraday.new(url: base_url) do |f|
          f.request :json
          f.response :json
          f.adapter Faraday.default_adapter
        end

        response = conn.get('/workbenches/vulnerabilities') do |req|
          req.headers['X-ApiKeys'] = valid_api_keys_header
        end

        vulnerability = response.body['vulnerabilities'].first
        expect(vulnerability['count']).to be_a(Integer)
        expect(vulnerability['plugin_id']).to be_a(Integer)
        expect(vulnerability['severity']).to be_a(Integer)
      end
    end

    context 'without valid authentication' do
      before do
        stub_request(:get, vulnerabilities_url)
          .with(headers: { 'X-ApiKeys' => 'accessKey=invalid;secretKey=invalid;' })
          .to_return(
            status: 401,
            headers: { 'Content-Type' => 'application/json' },
            body: unauthorized_response_body.to_json
          )
      end

      it 'returns 401 with an error response' do
        conn = Faraday.new(url: base_url) do |f|
          f.request :json
          f.response :json
          f.adapter Faraday.default_adapter
        end

        response = conn.get('/workbenches/vulnerabilities') do |req|
          req.headers['X-ApiKeys'] = 'accessKey=invalid;secretKey=invalid;'
        end

        expect(response.status).to eq(401)
        expect(response.body).to have_key('statusCode')
        expect(response.body['statusCode']).to eq(401)
        expect(response.body).to have_key('error')
        expect(response.body['error']).to eq('Unauthorized')
        expect(response.body).to have_key('message')
      end

      it 'returns a 401 that would raise Tenable::AuthenticationError' do
        conn = Faraday.new(url: base_url) do |f|
          f.request :json
          f.response :json
          f.adapter Faraday.default_adapter
        end

        response = conn.get('/workbenches/vulnerabilities') do |req|
          req.headers['X-ApiKeys'] = 'accessKey=invalid;secretKey=invalid;'
        end

        expect(response.status).to eq(401)
        expect { raise Tenable::AuthenticationError }.to raise_error(
          Tenable::AuthenticationError,
          /Authentication failed/
        )
      end
    end
  end
end
