# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Tenable::Models::Vulnerability do
  let(:asset_data) do
    {
      'uuid' => 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
      'hostname' => 'web-server-01',
      'ipv4' => '192.168.1.100',
      'operating_system' => ['Ubuntu 22.04'],
      'fqdn' => ['web-server-01.example.com'],
      'netbios_name' => 'WEBSERVER01'
    }
  end

  let(:full_hash) do
    {
      'plugin_id' => 12_345,
      'plugin_name' => 'Apache HTTP Server < 2.4.52 Multiple Vulnerabilities',
      'severity' => 'High',
      'severity_id' => 3,
      'state' => 'OPEN',
      'asset' => asset_data,
      'output' => 'Installed version: 2.4.49\nFixed version: 2.4.52',
      'first_found' => '2025-01-15T10:30:00Z',
      'last_found' => '2025-02-18T14:00:00Z',
      'last_fixed' => nil,
      'vpr_score' => 8.4,
      'cvss_base_score' => 9.8,
      'cve' => %w[CVE-2021-44790 CVE-2021-44224]
    }
  end

  let(:minimal_hash) do
    {
      'plugin_id' => 99_999,
      'plugin_name' => 'Test Plugin',
      'severity' => 'Info',
      'severity_id' => 0,
      'state' => 'OPEN'
    }
  end

  describe 'initialization from a hash' do
    subject(:vulnerability) { described_class.new(full_hash) }

    it 'sets plugin_id as an Integer' do
      expect(vulnerability.plugin_id).to eq(12_345)
      expect(vulnerability.plugin_id).to be_an(Integer)
    end

    it 'sets plugin_name as a String' do
      expect(vulnerability.plugin_name).to eq('Apache HTTP Server < 2.4.52 Multiple Vulnerabilities')
      expect(vulnerability.plugin_name).to be_a(String)
    end

    it 'sets severity as a String' do
      expect(vulnerability.severity).to eq('High')
      expect(vulnerability.severity).to be_a(String)
    end

    it 'sets severity_id as an Integer' do
      expect(vulnerability.severity_id).to eq(3)
      expect(vulnerability.severity_id).to be_an(Integer)
    end

    it 'sets state as a String' do
      expect(vulnerability.state).to eq('OPEN')
      expect(vulnerability.state).to be_a(String)
    end

    it 'sets output as a String' do
      expect(vulnerability.output).to eq('Installed version: 2.4.49\nFixed version: 2.4.52')
      expect(vulnerability.output).to be_a(String)
    end

    it 'sets first_found as a String' do
      expect(vulnerability.first_found).to eq('2025-01-15T10:30:00Z')
      expect(vulnerability.first_found).to be_a(String)
    end

    it 'sets last_found as a String' do
      expect(vulnerability.last_found).to eq('2025-02-18T14:00:00Z')
      expect(vulnerability.last_found).to be_a(String)
    end

    it 'sets last_fixed as nil when nil in data' do
      expect(vulnerability.last_fixed).to be_nil
    end

    it 'sets vpr_score as a Float' do
      expect(vulnerability.vpr_score).to eq(8.4)
      expect(vulnerability.vpr_score).to be_a(Float)
    end

    it 'sets cvss_base_score as a Float' do
      expect(vulnerability.cvss_base_score).to eq(9.8)
      expect(vulnerability.cvss_base_score).to be_a(Float)
    end

    it 'sets cve as an Array' do
      expect(vulnerability.cve).to eq(%w[CVE-2021-44790 CVE-2021-44224])
      expect(vulnerability.cve).to be_an(Array)
    end
  end

  describe 'nil defaults for missing attributes' do
    subject(:vulnerability) { described_class.new(minimal_hash) }

    it 'defaults output to nil' do
      expect(vulnerability.output).to be_nil
    end

    it 'defaults first_found to nil' do
      expect(vulnerability.first_found).to be_nil
    end

    it 'defaults last_found to nil' do
      expect(vulnerability.last_found).to be_nil
    end

    it 'defaults last_fixed to nil' do
      expect(vulnerability.last_fixed).to be_nil
    end

    it 'defaults vpr_score to nil' do
      expect(vulnerability.vpr_score).to be_nil
    end

    it 'defaults cvss_base_score to nil' do
      expect(vulnerability.cvss_base_score).to be_nil
    end

    it 'defaults cve to an empty Array' do
      expect(vulnerability.cve).to eq([])
    end

    it 'defaults asset to nil' do
      expect(vulnerability.asset).to be_nil
    end
  end

  describe 'embedded Asset model' do
    subject(:vulnerability) { described_class.new(full_hash) }

    it 'creates an Asset instance from the asset hash' do
      expect(vulnerability.asset).to be_a(Tenable::Models::Asset)
    end

    it 'sets the asset uuid' do
      expect(vulnerability.asset.uuid).to eq('a1b2c3d4-e5f6-7890-abcd-ef1234567890')
    end

    it 'sets the asset hostname' do
      expect(vulnerability.asset.hostname).to eq('web-server-01')
    end

    it 'sets the asset ipv4' do
      expect(vulnerability.asset.ipv4).to eq('192.168.1.100')
    end

    it 'sets the asset operating_system' do
      expect(vulnerability.asset.operating_system).to eq(['Ubuntu 22.04'])
    end

    it 'sets the asset fqdn' do
      expect(vulnerability.asset.fqdn).to eq(['web-server-01.example.com'])
    end

    it 'sets the asset netbios_name' do
      expect(vulnerability.asset.netbios_name).to eq('WEBSERVER01')
    end
  end
end
